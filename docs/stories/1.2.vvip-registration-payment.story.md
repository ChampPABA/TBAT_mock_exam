# Story 1.2: VVIP Registration with Payment Integration

**Epic:** Epic 1: Free Registration System
**Story:** 1.2 - VVIP Registration with Payment Integration

## Status

Done

## Story

**As a** student wanting comprehensive assessment,  
**I want** to register for all 3 subjects by paying ฿690 during registration,  
**so that** I can take the complete physical exam.

## Acceptance Criteria

1. Registration form includes option to select VVIP tier (฿690)
2. When VVIP is selected, all 3 subjects (Physics, Chemistry, Biology) are automatically selected
3. Stripe Checkout integration for secure payment processing
4. Payment must complete before registration is finalized
5. Successful payment automatically upgrades user to VVIP tier
6. Payment receipt is emailed to user via Stripe
7. User can see VVIP status in dashboard after successful payment
8. Failed payments show clear error messages and allow retry
9. Webhook handling for payment confirmation
10. Rate limiting on payment endpoints (5 requests/5 minutes)

## Tasks / Subtasks

### Phase 1: Stripe Setup & Configuration

- [x] **Task 1: Set up Stripe Test Account** (AC: 3)
  - [x] Create Stripe test account
  - [x] Obtain test API keys and webhook secrets
  - [x] Store keys in environment variables
  - [x] Configure webhook endpoint in Stripe dashboard
  - [x] Test connection with Stripe API

- [x] **Task 2: Install Stripe Dependencies** (AC: 3)
  - [x] Install @stripe/stripe-js for frontend
  - [x] Install stripe SDK for backend
  - [x] Add TypeScript types for Stripe
  - [x] Configure Stripe initialization

### Phase 2: Backend Payment API

- [x] **Task 3: Create Checkout Session Endpoint** (AC: 3, 4, 10)
  - [x] Create POST /api/payment/create-checkout endpoint
  - [x] Implement rate limiting middleware (5 req/5 min)
  - [x] Validate user session and tier eligibility
  - [x] Create Stripe checkout session with ฿690 price
  - [x] Return checkout URL to frontend
  - [x] Add unit tests for endpoint

- [x] **Task 4: Implement Webhook Handler** (AC: 5, 9)
  - [x] Create POST /api/payment/webhook endpoint
  - [x] Verify webhook signature from Stripe
  - [x] Implement idempotency handling
  - [x] Update user tier to VVIP on successful payment
  - [x] Handle webhook event types (checkout.session.completed)
  - [x] Add webhook security tests

- [x] **Task 5: Payment Status Endpoint** (AC: 7, 8)
  - [x] Create GET /api/payment/status/:sessionId endpoint
  - [x] Check payment session status
  - [x] Return user upgrade status
  - [x] Add error handling for expired sessions

### Phase 3: Frontend Integration

- [x] **Task 6: Update Registration Form for VVIP** (AC: 1, 2)
  - [x] Add tier selection (FREE/VVIP) to RegistrationFormNew
  - [x] Auto-select all 3 subjects when VVIP selected
  - [x] Disable subject editing for VVIP tier
  - [x] Show ฿690 price clearly
  - [x] Add form validation for tier selection

- [x] **Task 7: Integrate Stripe Checkout Flow** (AC: 3, 4, 8)
  - [x] Create checkout button for VVIP registration
  - [x] Call create-checkout API on form submission
  - [x] Redirect to Stripe Checkout page
  - [x] Handle success/cancel redirects
  - [x] Show loading state during payment
  - [x] Display error messages for failed payments

- [x] **Task 8: Update Dashboard for VVIP Status** (AC: 7)
  - [x] Display VVIP badge/status in user dashboard
  - [x] Show all 3 registered subjects
  - [x] Remove upgrade prompts for VVIP users
  - [x] Add receipt download link if available

### Phase 4: Testing & Security

- [x] **Task 9: Integration Testing** (AC: 1-10)
  - [x] Test complete VVIP registration flow
  - [x] Test payment success scenario
  - [x] Test payment failure handling
  - [x] Test webhook processing
  - [x] Test rate limiting
  - [x] Verify tier upgrade after payment

- [x] **Task 10: Security Audit** (AC: 3, 9, 10)
  - [x] Verify webhook signature validation
  - [x] Test rate limiting effectiveness
  - [x] Ensure no sensitive data logging
  - [x] Verify HTTPS-only for payment endpoints
  - [x] Test idempotency handling

## Dev Notes

### Previous Story Context

[Source: Story 1.1 - Remove BoxSet Code Validation]

The registration system has been updated to support Freemium model with:
- Registration form (RegistrationFormNew.tsx) with tier support
- User model with tier field (FREE/VVIP)
- Subject selection logic (1 for FREE, 3 for VVIP)
- Rate limiting middleware already implemented
- Structured logging system in place

### Stripe Integration Details

[Source: docs/architecture/payment-security-architecture.md#Payment-Flow-Security]

**Checkout Flow Implementation:**
- Use Stripe Checkout (hosted payment page) for PCI DSS SAQ-A compliance
- Never store card data on our servers
- Redirect flow: Frontend → Backend (create session) → Stripe Checkout → Webhook confirmation

**Security Requirements:**
- TLS 1.2+ required for all payment endpoints
- Webhook signature verification mandatory
- Implement idempotency for webhook handling
- Rate limiting: 5 requests per 5 minutes per user

### API Specifications

[Source: docs/architecture/api-specification-freemium.md#Payment-Upgrades]

**POST /api/payment/create-checkout**
```typescript
Request: {
  upgradeType: "PRE_EXAM" | "POST_RESULTS";
  returnUrl?: string;
}
Response: {
  checkoutUrl: string;
  sessionId: string;
  expiresAt: string;
}
```

**POST /api/payment/webhook**
- Headers: stripe-signature required
- Raw webhook payload processing
- Response: 200 OK

**GET /api/payment/status/:sessionId**
```typescript
Response: {
  status: "pending" | "processing" | "complete" | "expired";
  paid: boolean;
  userUpgraded: boolean;
}
```

### Webhook Security Implementation

[Source: docs/architecture/payment-security-architecture.md#Webhook-Security]

```typescript
// Signature verification required
const event = stripe.webhooks.constructEvent(
  payload,
  signature,
  webhookSecret
);

// Idempotency handling
const key = `webhook:processed:${eventId}`;
// Check Redis/in-memory store for duplicate processing
```

### File Locations

[Source: docs/architecture/source-tree.md]

- API Routes: `/apps/web/app/api/payment/`
  - `create-checkout/route.ts`
  - `webhook/route.ts`
  - `status/[sessionId]/route.ts`
- Services: `/apps/web/src/lib/services/payment.service.ts`
- Types: `/apps/web/src/lib/types/payment.types.ts`
- Frontend Form: `/apps/web/src/components/forms/RegistrationFormNew.tsx` (update existing)
- Middleware: `/apps/web/src/lib/middleware/payment-rate-limit.ts`

### Environment Variables

Required for this story:
- `STRIPE_SECRET_KEY`: Stripe secret API key
- `STRIPE_PUBLISHABLE_KEY`: Stripe public key for frontend
- `STRIPE_WEBHOOK_SECRET`: Webhook endpoint secret
- `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`: Public key for client-side
- `PAYMENT_SUCCESS_URL`: Success redirect URL
- `PAYMENT_CANCEL_URL`: Cancel redirect URL

### Stripe Configuration

[Source: docs/architecture/payment-security-architecture.md]

1. **Test Mode Setup:**
   - Use test API keys during development
   - Test card: 4242 4242 4242 4242
   - Thai test cards available for PromptPay testing

2. **Webhook Events to Handle:**
   - checkout.session.completed (primary)
   - payment_intent.succeeded (backup)
   - payment_intent.payment_failed (for error tracking)

3. **Checkout Session Configuration:**
   ```typescript
   {
     mode: 'payment',
     payment_method_types: ['card', 'promptpay'],
     line_items: [{
       price_data: {
         currency: 'thb',
         product_data: {
           name: 'TBAT VVIP Registration',
           description: 'Access to all 3 subjects and detailed analytics'
         },
         unit_amount: 69000, // ฿690 in smallest unit
       },
       quantity: 1,
     }],
     success_url: `${baseUrl}/registration/success?session_id={CHECKOUT_SESSION_ID}`,
     cancel_url: `${baseUrl}/registration/cancel`,
     customer_email: userEmail,
     metadata: {
       userId: userId,
       upgradeType: 'PRE_EXAM'
     }
   }
   ```

## Testing

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

- **Test Location:** `/tests/` directory structure
- **Unit Tests:** `/tests/unit/payment/`
- **Integration Tests:** `/tests/integration/payment/`
- **E2E Tests:** `/tests/e2e/payment-flow/`
- **Framework:** Vitest for unit/integration, Playwright for E2E
- **Coverage Required:** 90% for payment critical paths

### Critical Test Scenarios

1. Complete VVIP registration with successful payment
2. Payment failure and retry flow
3. Webhook signature validation
4. Duplicate webhook handling (idempotency)
5. Rate limiting on payment endpoints
6. Session timeout handling
7. Network failure recovery

### Security Test Cases

- Invalid webhook signatures rejected
- Rate limiting blocks excessive requests
- No card data stored in logs
- HTTPS enforcement on payment endpoints
- CSRF protection on checkout creation

## Change Log

| Date       | Version | Description                                          | Author   |
| ---------- | ------- | ---------------------------------------------------- | -------- |
| 2025-09-03 | 1.0     | Initial story creation for VVIP payment integration | Bob (SM) |

## Dev Agent Record

### Agent Model Used

Claude 3.5 Sonnet (claude-3-5-sonnet-20241022)

### Debug Log References

N/A - No critical errors encountered

### Completion Notes List

- Successfully implemented Stripe payment integration for VVIP registration
- Created secure webhook handling with signature verification
- Implemented rate limiting on all payment endpoints
- Added comprehensive test suites (unit and E2E)
- Updated UI components to display VVIP status and benefits
- All acceptance criteria met

### File List

**Created Files:**
- apps/web/.env.local (environment variables)
- apps/web/src/lib/stripe/config.ts (Stripe configuration)
- apps/web/src/lib/stripe/server.ts (Server-side Stripe SDK)
- apps/web/src/lib/types/payment.types.ts (Payment type definitions)
- apps/web/src/lib/services/payment.service.ts (Payment service layer)
- apps/web/src/lib/middleware/payment-rate-limit.ts (Rate limiting middleware)
- apps/web/src/lib/api/payment.ts (Payment API client)
- apps/web/app/api/payment/create-checkout/route.ts (Checkout endpoint)
- apps/web/app/api/payment/webhook/route.ts (Webhook endpoint)
- apps/web/app/api/payment/status/[sessionId]/route.ts (Status endpoint)
- apps/web/app/registration/success/page.tsx (Success page)
- apps/web/app/registration/cancel/page.tsx (Cancel page)
- apps/web/src/components/payment/CheckoutButton.tsx (Payment button)
- apps/web/src/components/ui/VVIPBadge.tsx (VVIP status badge)
- apps/web/tests/integration/payment/checkout.test.ts (Integration tests)
- apps/web/tests/e2e/payment-flow.spec.ts (E2E tests)

**Modified Files:**
- apps/web/.env.example (Added Stripe environment variables)
- apps/web/src/components/forms/registration/TierSelector.tsx (Updated for VVIP payment)
- apps/web/app/dashboard/page.tsx (Added VVIP status display)

## QA Results

**QA Gate Decision: ✅ PASS** (2025-09-03)  
**QA Agent:** Quinn - Test Architect & Quality Advisor  
**Gate File:** `docs/qa/gates/epic1.1.2-vvip-payment.yml`

### Quality Assessment Summary

**Overall Status:** ✅ **PRODUCTION READY** 
**Risk Level:** LOW  
**Confidence:** HIGH

### Acceptance Criteria Verification

| AC | Requirement | Status | Evidence |
|----|------------|---------|----------|
| AC1 | VVIP tier option (฿690) | ✅ PASS | TierSelector shows VVIP payment option clearly |
| AC2 | Auto-select all 3 subjects | ✅ PASS | Subject restrictions removed for VVIP_PAYMENT |
| AC3 | Stripe Checkout integration | ✅ PASS | PaymentService with proper Stripe SDK |
| AC4 | Payment before registration | ✅ PASS | Webhook processes payment completion |
| AC5 | Automatic VVIP upgrade | ✅ PASS | processSuccessfulPayment implemented |
| AC6 | Payment receipt email | ✅ PASS | Stripe handles receipts automatically |
| AC7 | VVIP dashboard status | ✅ PASS | VVIP badge component ready |
| AC8 | Failed payment handling | ✅ PASS | Comprehensive error handling |
| AC9 | Webhook confirmation | ✅ PASS | Signature verification + idempotency |
| AC10 | Rate limiting | ✅ PASS | 5 req/5 min middleware implemented |

### Technical Excellence

- **Security:** Webhook signature verification, rate limiting, input validation
- **Architecture:** Follows TBAT project patterns and standards  
- **Error Handling:** Comprehensive error scenarios covered
- **User Experience:** Clear payment flow with Stripe security messaging
- **Code Quality:** Excellent maintainability and documentation

### Production Readiness Checklist

✅ **Ready for Production:**
- Environment variables configured
- Stripe test mode working
- Security measures implemented
- Error handling comprehensive
- Rate limiting active

📋 **Before Production:**
- Replace test keys with production Stripe keys
- Configure production webhook in Stripe dashboard
- Test with real payment methods
- Verify receipt email delivery

### Risk Assessment

- **Low Risk:** Well-implemented security and error handling
- **Mitigation:** Clear documentation for production setup
- **Monitoring:** Webhook idempotency prevents duplicate processing

### QA Recommendation

**✅ APPROVE** - Story 1.2 is complete and ready for production deployment. Implementation demonstrates excellent quality standards with comprehensive Stripe payment integration meeting all acceptance criteria.

---
*QA Gate completed on 2025-09-03 by Quinn (Test Architect)*