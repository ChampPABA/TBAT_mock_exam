# Story 1.2.1: Registration & Session Selection Enhancement

## Status

Approved

## Story

**As a** Frontend Developer,
**I want** to enhance the existing registration page with password fields and add comprehensive session time selection functionality,
**so that** users can complete a more comprehensive registration process matching PO requirements while maintaining the current dedicated page structure (using email as username).

## Acceptance Criteria

1. **AC1:** Add password field with confirmation to existing registration form with validation (8+ characters, letters+numbers requirement) - using existing email field as username

2. **AC2:** Implement session time selection component allowing users to choose between "9:00-12:00" and "13:00-16:00" time slots

3. **AC3:** Integrate session selection with existing package selection flow on the registration page

4. **AC4:** Update form validation to include new password fields with Thai language error messages

5. **AC5:** Maintain existing registration page layout and design while accommodating new fields

## Tasks / Subtasks

- [ ] Task 1: Review and understand current registration implementation (AC: 1, 4, 5)
  - [ ] Analyze existing /register page structure and components
  - [ ] Review current form validation implementation using React Hook Form
  - [ ] Document current user flow and identify integration points
  - [ ] Verify existing package selection and PDPA consent functionality
  - [ ] Confirm email field is already present and working as username

- [ ] Task 2: Add password fields with validation (AC: 1, 4)
  - [ ] Add password and confirm password fields to registration form
  - [ ] Implement password validation: 8+ characters, must contain letters and numbers
  - [ ] Add password confirmation matching validation
  - [ ] Implement Thai language error messages for password validation
  - [ ] Add password visibility toggle functionality

- [ ] Task 3: Create session selection component (AC: 2, 3)
  - [ ] Create SessionSelection component with TypeScript interfaces
  - [ ] Implement radio button or select interface for "9:00-12:00" and "13:00-16:00" options
  - [ ] Add proper ARIA labels and accessibility support for Thai language
  - [ ] Style component consistent with existing design system
  - [ ] Add validation requiring session selection before form submission

- [ ] Task 4: Integrate session selection with package flow (AC: 2, 3, 5)
  - [ ] Integrate SessionSelection component into existing registration page layout
  - [ ] Update form submission to include selected session time
  - [ ] Connect session selection with package selection logic from Story 1.2
  - [ ] Ensure session selection works with both Free and Advanced packages

- [ ] Task 5: Update form validation and user experience (AC: 4, 5)
  - [ ] Update React Hook Form schema to include password and session fields (email already exists)
  - [ ] Add comprehensive form validation with Thai language error messages
  - [ ] Update existing PDPA consent flow to work with new fields
  - [ ] Test complete form submission flow with password and session fields added to existing email/form

- [ ] Task 6: Testing and responsive design validation (AC: All)
  - [ ] Test enhanced registration form on mobile devices (primary target)
  - [ ] Validate form works correctly with all field combinations
  - [ ] Test error states and validation messages display properly in Thai
  - [ ] Ensure registration success flow works with new field data
  - [ ] Update E2E tests to cover new registration field requirements

## Dev Notes

### Previous Story Context

**Story 1.2 Implementation Status**: Story 1.2 (Frontend Development with Mock Data) is completed with production-ready registration page at `/register` route. The current implementation includes:

- ✅ Dedicated registration page (NOT modal) at `/register` route
- ✅ Multi-step form with package selection, personal details, PDPA consent
- ✅ React Hook Form integration with validation
- ✅ Thai language support and mobile-responsive design
- ✅ Mock data integration for package selection
- ✅ PDPA consent checkbox validation

[Source: docs/stories/1.2.frontend-development-with-mock-data.md]

### Data Models & Integration Requirements

**User Model - No Changes Required:**

```typescript
interface User {
  id: string;
  email: string; // Existing - SERVES AS USERNAME (no additional username field needed)
  password_hash: string; // Existing - needs frontend password field added to registration
  thai_name: string; // Existing
  phone: string; // Existing
  school: string; // Existing
  package_type: "FREE" | "ADVANCED"; // Existing
  pdpa_consent: boolean; // Existing
  created_at: Date;
  updated_at: Date;
}

interface ExamCode {
  id: string;
  user_id: string;
  code: string;
  package_type: "FREE" | "ADVANCED";
  subject: "BIOLOGY" | "CHEMISTRY" | "PHYSICS";
  session_time: "09:00-12:00" | "13:00-16:00"; // CRITICAL: This field exists and needs frontend selection
  is_used: boolean;
  created_at: Date;
  used_at?: Date;
}
```

[Source: docs/architecture/section-4-data-models.md]

### Session Capacity Integration

**Session Selection Requirements:**

```typescript
interface SessionCapacity {
  id: string;
  session_time: "09:00-12:00" | "13:00-16:00"; // MUST match ExamCode.session_time
  current_count: number;
  max_capacity: number; // 300 exam participants per session
  exam_date: Date; // 27 กันยายน 2568
  created_at: Date;
  updated_at: Date;
}
```

[Source: docs/architecture/section-4-data-models.md]

### File Structure Integration Points

**Existing Registration Implementation Files (Story 1.2):**

- `apps/web/app/register/page.tsx` - Main registration page (MODIFY)
- `apps/web/components/landing/registration-modal.tsx` - Registration form component (MODIFY)
- `apps/web/lib/mock-data.ts` - Mock data service (EXTEND for session data)

**New Component Files to Create:**

- `apps/web/components/forms/session-selection.tsx` - Session time selection component
- `apps/web/components/forms/password-input.tsx` - Password field with toggle visibility (optional)

### Technical Integration Requirements

**Form Validation Integration:**

- Extend existing React Hook Form schema in registration form
- Add password validation schema (8+ chars, letters+numbers)
- Add password confirmation validation (must match password)
- Add session_time required field validation

**Thai Language Error Messages:**

```typescript
const validationMessages = {
  password: {
    required: "กรุณากรอกรหัสผ่าน",
    minLength: "รหัสผ่านต้องมีอย่างน้อย 8 ตัวอักษร",
    pattern: "รหัสผ่านต้องมีทั้งตัวอักษรและตัวเลข",
  },
  confirmPassword: {
    required: "กรุณายืนยันรหัสผ่าน",
    match: "รหัสผ่านไม่ตรงกัน",
  },
  sessionTime: {
    required: "กรุณาเลือกเวลาสอบ",
  },
};
```

### Design System Integration

**shadcn/ui Components to Use:**

- Input component for username field
- Input component with type="password" for password fields
- RadioGroup or Select for session time selection
- Button component for password visibility toggle
- Label components with proper ARIA attributes

**Styling Consistency:**

- Maintain existing TBAT color palette (#0d7276 primary, #529a9d secondary)
- Follow existing form field spacing and layout patterns
- Ensure mobile-first responsive design matches current registration page

### Business Logic Constraints

**Email as Username:**

- Email field already exists in current registration form
- No additional username field needed - email serves as unique identifier
- Email validation already implemented in Story 1.2

**Password Requirements:**

- 8+ characters minimum length
- Must contain both letters and numbers
- Password confirmation field must match
- Frontend validation only - hashing handled by backend

**Security Considerations:**

- Rate limiting: Registration form should implement client-side throttling to prevent rapid submission attempts
- CSRF protection: Form submission should include CSRF token validation (handled by Next.js middleware)
- Input sanitization: All form inputs should be properly sanitized before submission
- Password visibility toggle: Ensure secure handling of password field state

**Session Selection Requirements:**

- Required field - user must select either 9:00-12:00 or 13:00-16:00
- Display Thai time format for better user experience: "เช้า 09:00-12:00" / "บ่าย 13:00-16:00"
- Integrate with package selection - both Free and Advanced users need session selection

### Testing Requirements

**Unit Testing:**

- Password field validation and confirmation matching
- Session selection component functionality
- Form submission with all new fields

**Integration Testing:**

- Complete registration flow with username, password, and session fields
- Form validation error display in Thai language
- Mobile responsive behavior with new fields
- PDPA consent flow integration with enhanced form

**E2E Testing Updates:**

- Update existing registration E2E tests to include new fields
- Test complete user journey from landing page through registration with session selection
- Test error states for all validation requirements
- Test accessibility with Thai language screen readers

[Source: docs/stories/1.2.frontend-development-with-mock-data.md#testing]

## Testing

### Unit Testing

**Framework**: Jest with React Testing Library
**Test Location**: Co-located with components (\*.test.tsx files)
**Key Test Scenarios**:

- Password input validation and confirmation matching (no username field needed)
- Session selection component state management
- Form integration with existing package selection and PDPA consent
- Thai language error message display

### E2E Testing

**Framework**: Playwright (existing test suite)
**Test File Extensions**: Update existing `apps/web/e2e/landing-page.spec.ts`
**Critical User Flows**:

1. Registration with email (as username), password, and session selection
2. Form validation error handling for all new fields
3. Complete registration flow from package selection to session confirmation
4. Mobile responsive behavior testing

### Accessibility Testing

**Standards**: WCAG 2.1 Level AA compliance
**Tools**: axe-core automated testing, manual keyboard navigation testing
**Commands**:

```bash
npm run test:accessibility  # Run axe-core accessibility tests
npm run test:a11y:manual    # Manual accessibility testing checklist
```

**Focus Areas**:

- Keyboard navigation through enhanced registration form
- Screen reader compatibility with Thai language content (test with NVDA/JAWS)
- Focus management with new password visibility toggles
- ARIA labels for session selection radio buttons
- Color contrast validation for new form elements
- Touch target size validation for mobile devices

## Change Log

| Date       | Version | Description                                                                                                | Author |
| ---------- | ------- | ---------------------------------------------------------------------------------------------------------- | ------ |
| 2025-09-12 | 1.0     | Initial story creation for registration enhancements based on PO requirements                              | SM Bob |
| 2025-09-12 | 1.1     | Updated to use email as username (no separate username field needed) - simplified implementation           | SM Bob |
| 2025-09-12 | 1.2     | Added security considerations (rate limiting, CSRF protection) and enhanced accessibility testing guidance | SM Bob |
| 2025-09-12 | 1.3     | Status updated to Approved - ready for development implementation                                          | SM Bob |

## Dev Agent Record

_This section is populated by the development agent during implementation_

### Agent Model Used

_[Agent model information will be recorded here during implementation]_

### Debug Log References

_[Debug logs and traces will be referenced here during development]_

### Completion Notes List

_[Implementation notes and issues encountered will be documented here]_

### File List

_[All files created, modified, or affected during story implementation will be listed here]_

## QA Results

_[QA Agent review results will be populated here after implementation completion]_
