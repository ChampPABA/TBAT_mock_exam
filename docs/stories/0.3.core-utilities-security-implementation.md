# Story 0.3: Core Utilities & Security Implementation

## Status

✅ APPROVED  
**Approved Date:** 2025-01-07  
**Approved By:** Scrum Master (Bob)

## Story

**As a** Developer,
**I want** to implement essential security measures and utility functions,
**so that** all features can handle exam codes, data protection, and user safety reliably.

## Acceptance Criteria

**AC1:** Random exam code generation service implemented with collision prevention (FREE-[8-CHAR]-[SUBJECT], ADV-[8-CHAR])

**AC2:** Password hashing service implemented with bcrypt and secure validation rules (8+ characters, letters + numbers)

**AC3:** Basic PDPA compliance implemented with consent form, data export capability, and user data deletion

**AC4:** Input validation and sanitization utilities established using Zod schemas for all user inputs

**AC5:** Error logging and monitoring service (Sentry) configured with alerting for critical failures

**AC6:** Rate limiting middleware implemented for API endpoints with special consideration for payment routes

**AC7:** Docker environment security configuration implemented:

- Environment variables properly managed via .env.docker file
- Secrets not exposed in Docker images or logs
- PDPA compliance features accessible in containerized environment
- Rate limiting middleware tested in Docker setup

**AC8:** Utility services verified in Docker:

- Exam code generation service functional in container
- Password hashing service working with proper entropy
- Error logging (Sentry) configured with Docker environment flag
- All utilities accessible via Docker network

## Tasks / Subtasks

- [ ] Task 1: Implement Exam Code Generation Service (AC: 1, 8)
  - [ ] Create `lib/exam-code.ts` with cryptographically secure random generation
  - [ ] Implement collision detection against existing codes in database
  - [ ] Add audit logging for code generation
  - [ ] Create unit tests for code generation patterns
  - [ ] Test in Docker environment

- [ ] Task 2: Enhance Password Security Service (AC: 2, 8)
  - [ ] Update `lib/auth.ts` with password validation rules
  - [ ] Implement account lockout after 5 failed attempts
  - [ ] Add password policy enforcement (min 8 chars, letters + numbers)
  - [ ] Create unit tests for password validation
  - [ ] Verify bcrypt entropy in Docker

- [ ] Task 3: Implement PDPA Compliance Features (AC: 3, 7)
  - [ ] Create `lib/pdpa.ts` with consent management functions
  - [ ] Implement user data export functionality
  - [ ] Add user data deletion with cascade operations
  - [ ] Create data anonymization utilities
  - [ ] Build PDPA compliance API endpoints
  - [ ] Test PDPA features in Docker environment

- [ ] Task 4: Enhance Input Validation with Zod (AC: 4)
  - [ ] Extend existing `lib/api-validation.ts` with comprehensive schemas
  - [ ] Create validation schemas for all user inputs
  - [ ] Add Thai language validation patterns
  - [ ] Implement XSS prevention via DOMPurify
  - [ ] Create validation middleware for all API routes
  - [ ] Write tests for validation schemas

- [ ] Task 5: Integrate Sentry Error Monitoring (AC: 5, 7)
  - [ ] Install and configure Sentry SDK
  - [ ] Create `lib/monitoring.ts` with error capturing
  - [ ] Set up alerting for critical failures
  - [ ] Configure different logging levels per environment
  - [ ] Add Docker environment flag for Sentry
  - [ ] Test error reporting in all environments

- [ ] Task 6: Enhance Rate Limiting Implementation (AC: 6, 7)
  - [ ] Extend existing `lib/rate-limit.ts` with route-specific limits
  - [ ] Add special configuration for payment routes
  - [ ] Implement IP-based and user-based rate limiting
  - [ ] Configure rate limits per environment
  - [ ] Test rate limiting in Docker setup
  - [ ] Add monitoring for rate limit violations

- [ ] Task 7: Security Utilities Integration (AC: 7, 8)
  - [ ] Create `.env.docker.example` with secure defaults
  - [ ] Update `docker-compose.yml` with security configurations
  - [ ] Implement secrets management for Docker
  - [ ] Create security audit logging system
  - [ ] Test all utilities via Docker network
  - [ ] Document security best practices

- [ ] Task 8: Comprehensive Testing (AC: 1-8)
  - [ ] Write unit tests for all security utilities
  - [ ] Create integration tests for PDPA workflows
  - [ ] Test rate limiting under load
  - [ ] Verify exam code uniqueness with concurrent generation
  - [ ] Test password security features
  - [ ] Run security vulnerability scan
  - [ ] Document test coverage metrics

## Dev Notes

### Previous Story Insights

From Story 0.2 completion:

- Rate limiting middleware already partially implemented in `lib/rate-limit.ts` (QA Fix: SEC-001)
- API validation middleware with Zod already created in `lib/api-validation.ts` (QA Fix: SEC-003)
- bcryptjs already installed and used in `lib/auth.ts` for password hashing
- Zod already installed (v4.1.5) and configured
- express-rate-limit already installed (v8.1.0)
- Redis/Upstash already configured for caching in `lib/redis.ts`
- PDPA compliance checklist created in `apps/web/PDPA_COMPLIANCE_CHECKLIST.md` (QA Fix: SEC-002)

### Security Architecture Details

[Source: architecture/section-8-security.md]

**Authentication & Password Security:**

- Password requirements: 8+ chars, letters + numbers, no special chars required (simplified for Thai users)
- Password hashing: bcrypt with saltRounds = 12 for high security
- Account lockout: 5 attempts max, 30-minute lockout duration
- Session management: JWT with 7-day expiry

**PDPA Compliance Requirements:**

- Consent management: Required, granular, withdrawable, with record keeping
- Data minimization: 6-month max storage, collect only necessary data
- User rights: Data access, portability, deletion, correction (Thai: ขอดูข้อมูล, ขอรับโอนข้อมูล, ขอลบข้อมูล, ขอแก้ไขข้อมูล)
- Data classification: SENSITIVE (payment, scores), PERSONAL (name, email), OPERATIONAL (exam codes)

**Exam Code Generation:**

- Pattern: FREE-[8CHAR]-[SUBJECT] for free package, ADV-[8CHAR] for advanced
- Algorithm: Cryptographically secure random generation
- Collision checking required before saving
- Audit trail for all code generation

**Input Validation Requirements:**

- Use Zod schemas for all user inputs
- Thai name validation: min 2, max 100 characters
- Phone validation: Thai format, 10 digits (regex: /^[0-9]{10}$/)
- Email validation with proper format checking
- XSS prevention via DOMPurify sanitization

**Rate Limiting Configuration:**

- Standard endpoints: 100 requests per 15 minutes per IP
- Authentication endpoints: Enhanced protection (already implemented)
- Payment routes: Special consideration needed
- Error message in Thai: "คำขอเกินกำหนด กรุณาลองใหม่ในภายหลัง"

**Error Monitoring Requirements:**

- Different logging levels: development (verbose), staging (standard), production (error_and_audit)
- Security event types: AUTHENTICATION_FAILURE, MULTIPLE_LOGIN_ATTEMPTS, ADMIN_DATA_ACCESS, PDF_UNAUTHORIZED_ACCESS
- Incident response times: Severity 1 (30 min), Severity 2 (2 hrs), Severity 3 (24 hrs)

### File Locations

Based on existing project structure:

- Security utilities: `apps/web/lib/`
  - `exam-code.ts` (new)
  - `auth.ts` (existing, needs enhancement)
  - `pdpa.ts` (new)
  - `api-validation.ts` (existing, needs extension)
  - `monitoring.ts` (new)
  - `rate-limit.ts` (existing, needs extension)
- API endpoints: `apps/web/app/api/`
  - `pdpa/` directory for PDPA-related endpoints (new)
  - `admin/audit/` for audit logging endpoints (new)
- Configuration files:
  - `.env.docker.example` (new)
  - `docker-compose.yml` (existing, needs update)

### Testing Standards

[Source: Previous story implementation]

- Test files location: `apps/web/__tests__/lib/` for unit tests
- E2E tests: `apps/web/e2e/` for Playwright tests
- Testing frameworks: Jest (v30+) for unit tests, Playwright for E2E
- Test commands already configured in package.json
- Coverage requirement: >80% for critical security functions
- ESM configuration already fixed (QA Fix: TEST-001)

### Docker Integration Notes

- Docker Compose already configured with PostgreSQL and Redis
- Environment variables managed via .env files
- Health checks implemented for services
- Migration automation on startup configured
- Need to add security-specific environment configs

### Dependencies Status

Already installed (from package.json):

- bcryptjs (3.0.2) - Password hashing
- zod (4.1.5) - Schema validation
- express-rate-limit (8.1.0) - Rate limiting
- jsonwebtoken (9.0.2) - JWT handling
- @upstash/redis (1.35.3) - Redis caching

Need to install:

```bash
pnpm add @sentry/nextjs dompurify
pnpm add -D @types/dompurify
```

### Code Examples & Patterns

**Exam Code Generation Pattern:**

```typescript
// lib/exam-code.ts
import { randomBytes } from "crypto";

export async function generateExamCode(
  packageType: "FREE" | "ADVANCED",
  subject?: "BIOLOGY" | "CHEMISTRY" | "PHYSICS"
): Promise<string> {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  const randomPart = randomBytes(8)
    .toString("base64")
    .replace(/[^A-Z0-9]/gi, "")
    .substring(0, 8);

  const code = packageType === "FREE" ? `FREE-${randomPart}-${subject}` : `ADV-${randomPart}`;

  // Check uniqueness against database
  const exists = await prisma.examCode.findUnique({ where: { code } });
  if (exists) return generateExamCode(packageType, subject); // Recursive retry

  return code;
}
```

**PDPA Data Export Format:**

```typescript
// lib/pdpa.ts
interface UserDataExport {
  personalInfo: {
    email: string;
    thaiName: string;
    phone: string;
    school: string;
  };
  examData: {
    codes: ExamCode[];
    results: ExamResult[];
    payments: Payment[];
  };
  metadata: {
    exportedAt: Date;
    dataRetentionExpiry: Date;
    format: "JSON" | "CSV";
  };
}
```

**Rate Limiting Configuration:**

```typescript
// lib/rate-limit.ts
export const rateLimitConfig = {
  standard: { windowMs: 15 * 60 * 1000, max: 100 },
  auth: { windowMs: 15 * 60 * 1000, max: 5 },
  payment: { windowMs: 60 * 60 * 1000, max: 10 },
  pdpa: { windowMs: 24 * 60 * 60 * 1000, max: 3 },
};
```

### Performance Requirements

**Response Time Targets:**

- Exam code generation: < 100ms (including uniqueness check)
- Password hashing: < 200ms
- PDPA data export: < 5 seconds for full user data
- Input validation: < 10ms per field
- Rate limit check: < 5ms

**Concurrent Load Targets:**

- Support 20 concurrent exam code generations
- Handle 100 concurrent API requests with rate limiting
- Process 10 concurrent PDPA data exports

### Integration Points

**External Service Integrations:**

1. **Sentry Integration:**
   - DSN: `SENTRY_DSN` environment variable
   - Environment: `SENTRY_ENVIRONMENT` (development/staging/production)
   - Release tracking: Auto-detect from git commit

2. **Existing Service Connections:**
   - Prisma Client: Use existing singleton from `lib/prisma.ts`
   - Redis Client: Use existing connection from `lib/redis.ts`
   - NextAuth: Extend existing session from `lib/auth.ts`

3. **API Route Integration:**
   ```typescript
   // All API routes must include:
   import { validateRequest } from "@/lib/api-validation";
   import { rateLimit } from "@/lib/rate-limit";
   import { auditLog } from "@/lib/monitoring";
   ```

### Monitoring & Metrics

**Key Performance Indicators (KPIs):**

- Failed login attempts per hour (threshold: >50 = alert)
- Exam code generation failures (threshold: >1% = investigate)
- PDPA request response time P95 (target: <5s)
- Rate limit violations per endpoint (monitor for abuse)
- Sentry error rate (critical: >10 errors/minute)

**Dashboard Metrics:**

```typescript
// lib/monitoring.ts
export const metrics = {
  security: {
    failedLogins: "auth.login.failed",
    accountLockouts: "auth.account.locked",
    rateLimitHits: "ratelimit.exceeded",
  },
  pdpa: {
    dataExports: "pdpa.export.count",
    dataDeletions: "pdpa.delete.count",
    consentUpdates: "pdpa.consent.updated",
  },
  performance: {
    codeGenTime: "examcode.generation.duration",
    validationTime: "validation.duration",
  },
};
```

### Rollback Plan

**If Critical Issues Occur:**

1. **Immediate Actions (< 5 minutes):**
   - Disable Sentry if causing performance issues: Set `SENTRY_ENABLED=false`
   - Revert rate limiting to previous values via environment variables
   - Switch to simplified validation schemas if causing errors

2. **Rollback Procedure:**

   ```bash
   # Quick rollback via feature flags
   ENABLE_ENHANCED_SECURITY=false
   ENABLE_PDPA_FEATURES=false
   ENABLE_SENTRY_MONITORING=false

   # Full code rollback if needed
   git revert HEAD
   vercel rollback [deployment-id]
   ```

3. **Data Rollback:**
   - PDPA consent records: Soft delete with `deleted_at` timestamp
   - Audit logs: Never delete, mark with `rollback_reason`
   - Rate limit counters: Auto-reset via Redis TTL

### Migration Strategy

**Database Migrations Required:**

```sql
-- New tables for Story 0.3
CREATE TABLE audit_logs (...);
CREATE TABLE pdpa_consents (...);
CREATE TABLE security_events (...);

-- New columns on existing tables
ALTER TABLE users ADD COLUMN failed_login_attempts INT DEFAULT 0;
ALTER TABLE users ADD COLUMN locked_until TIMESTAMP;
ALTER TABLE exam_codes ADD COLUMN generation_metadata JSONB;
```

### Security Validation Checklist

Pre-deployment verification:

- [ ] All Zod schemas have Thai error messages
- [ ] Rate limits tested under load
- [ ] PDPA export includes all user data
- [ ] Sentry captures errors correctly
- [ ] Password validation rejects weak passwords
- [ ] Exam codes pass uniqueness stress test
- [ ] Docker secrets not exposed in logs
- [ ] API endpoints return proper error codes

## Testing

### Testing Standards

- Unit test files: `apps/web/__tests__/lib/[utility-name].test.ts`
- Integration test files: `apps/web/__tests__/api/[endpoint].integration.test.ts`
- E2E test files: `apps/web/e2e/security.spec.ts`, `apps/web/e2e/pdpa.spec.ts`
- Use Jest for unit/integration tests with ESM configuration
- Use Playwright for E2E testing of security workflows
- Mock external services (Sentry) in test environment
- Test database operations with test data from seed script
- Ensure all security functions have >80% test coverage
- Run tests in Docker environment to verify containerized behavior

### Test Scenarios to Cover

- Exam code generation uniqueness under concurrent requests
- Password validation with various input combinations
- Rate limiting behavior at threshold boundaries
- PDPA data export format and completeness
- User data deletion cascade operations
- Error reporting to Sentry with different severity levels
- Input validation for Thai language characters
- Security headers in API responses

## Change Log

| Date       | Version | Description                                                                             | Author             |
| ---------- | ------- | --------------------------------------------------------------------------------------- | ------------------ |
| 2025-01-07 | 1.0     | Initial story draft created                                                             | Scrum Master (Bob) |
| 2025-01-07 | 1.1     | Enhanced with code examples, performance targets, rollback plan, and monitoring metrics | Scrum Master (Bob) |
| 2025-01-07 | 1.2     | Story approved for development                                                          | Scrum Master (Bob) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

_This section will be populated by the QA agent after story completion_
