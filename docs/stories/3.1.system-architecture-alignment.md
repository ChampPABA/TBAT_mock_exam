# Story 3.1: System Architecture Alignment

## Status
Approved

## Story
**As a** Technical Lead,
**I want** to align the entire TBAT platform (Frontend/Backend/API/Database) with the updated business requirements for capacity management and exam code generation,
**so that** the system implements consistent business logic across all layers following the documented architectural specifications.

## Acceptance Criteria

**AC1:** Frontend capacity display components updated to never show exact capacity numbers, only availability status messaging

**AC2:** Backend API endpoints implement the new capacity algorithm: 300 total limit, 150 free cap, advanced package priority logic

**AC3:** Database schema aligned with CapacityManagement data model including computed fields for availability status

**AC4:** Exam code generation updated to use new format: FREE-XXXX-SUBJECT or ADV-XXXX (4 alphanumeric uppercase characters)

**AC5:** API endpoints updated to return capacity status without exposing exact numbers (UI compliance)

**AC6:** End-to-end system testing validates complete capacity management workflow and exam code generation

## Tasks / Subtasks

- [ ] **Frontend Capacity Components Update** (AC: 1, 5)
  - [ ] Update capacity display components to remove exact number display
  - [ ] Implement disabled/transparent states for full sessions
  - [ ] Add availability status messaging without numbers
  - [ ] Update package selection wizard capacity logic

- [ ] **Backend Capacity Algorithm Implementation** (AC: 2, 3)
  - [ ] Implement CapacityManagement service with business rules
  - [ ] Create capacity checking logic: current_free < 150 AND total < 300
  - [ ] Implement advanced package priority: can fill unused free slots
  - [ ] Add computed fields for availability status

- [ ] **Database Schema Alignment** (AC: 3)
  - [ ] Update SessionCapacity table to match CapacityManagement interface
  - [ ] Add database triggers for real-time capacity computation
  - [ ] Create indexes for high-frequency capacity queries
  - [ ] Migrate existing capacity data to new schema

- [ ] **Exam Code Generation Update** (AC: 4)
  - [ ] Update ExamCode generation to use 4-character format
  - [ ] Implement cryptographically random XXXX generation
  - [ ] Add uniqueness validation for generated codes
  - [ ] Update existing code validation logic

- [ ] **API Endpoint Updates** (AC: 2, 5)
  - [ ] Update GET /api/capacity/status to hide exact numbers
  - [ ] Modify GET /api/sessions to return availability messaging
  - [ ] Update POST /api/exam/register capacity validation
  - [ ] Implement rate limiting for capacity endpoints

- [ ] **Integration Testing** (AC: 6)
  - [ ] Test complete registration flow with new capacity logic
  - [ ] Validate exam code generation and validation
  - [ ] Test capacity management across multiple concurrent users
  - [ ] Verify UI displays proper availability status

## Dev Notes

### Previous Story Insights
This replaces the original Epic 3.1 UI/UX Mockup story to prioritize system architecture alignment based on Sprint Change Proposal requirements.

### Data Models
**CapacityManagement Interface** [Source: architecture/section-4-data-models.md#capacity-management]:
```typescript
interface CapacityManagement {
  id: string;
  total_capacity: number; // 300 seats absolute maximum
  free_capacity: number; // 150 seats hard cap
  advanced_capacity: number; // Flexible up to remaining total
  current_free_count: number;
  current_advanced_count: number;
  exam_date: Date; // 27 กันยายน 2568
  is_full: boolean; // Computed: total >= 300
  free_slots_available: boolean; // Computed: current_free < 150 && !is_full
  advanced_slots_available: boolean; // Computed: !is_full
  created_at: Date;
  updated_at: Date;
}
```

**Updated ExamCode Format** [Source: architecture/section-4-data-models.md#exam-registration-codes]:
- **Free Package:** `FREE-XXXX-SUBJECT` (SUBJECT = BIOLOGY|CHEMISTRY|PHYSICS)
- **Advanced Package:** `ADV-XXXX`
- **XXXX Format:** 4 characters, mixed numbers and uppercase English letters (NOT 8 characters as in original Epic 3.1)
- **Generation:** Cryptographically random, validated for uniqueness

### API Specifications
**API Implementation Status** [Source: architecture/section-5-api-specification.md#exam-registration--code-generation]:

**Existing Endpoints to Update:**
- GET /api/exam/sessions - Currently returns available_spots and total_capacity, needs update to hide exact numbers
- POST /api/exam/register - Existing registration endpoint needs capacity algorithm update

**New Endpoints to Create:**
- GET /api/capacity/status - Real-time availability without numbers (UI compliance)
- GET /api/capacity/check - Capacity validation for registration flow

### Component Specifications
**Frontend Components** [Source: architecture/section-6-components.md#exam-management-components]:
- ExamRegistration interface defined - needs implementation with updated capacityCheck function for new algorithm
- ExamCodeDisplay interface defined - needs implementation with new 4-character format support
- Need to create capacity status messaging components for UI compliance (not exposing numbers)

### Business Logic Constraints
**Capacity Management Rules** [Source: architecture/section-4-data-models.md#business-logic-constraints]:
- **Total Capacity:** 300 participants maximum (absolute limit)
- **Free Package:** Maximum 150 registrations (hard cap)
- **Advanced Package:** Can fill any remaining slots up to total capacity
- **Priority Logic:** Advanced can take unused free slots
- **UI Display:** Never show capacity numbers to users
- **UX Behavior:** Disable session selection when full, show as transparent/grayed out

### File Locations
Based on Next.js 14+ App Router structure [Source: architecture/section-3-tech-stack.md]:

**Frontend Components:**
- Main components: `apps/web/components/exam/`
- Exam registration component: `apps/web/components/exam/ExamRegistration.tsx` (to be created)
- Exam code display: `apps/web/components/exam/ExamCodeDisplay.tsx` (to be created)
- Capacity status: `apps/web/components/ui/CapacityStatus.tsx` (to be created)

**API Routes:**
- Existing routes: `apps/web/app/api/exam/`
- New capacity routes: `apps/web/app/api/capacity/` (to be created)

**Database & Types:**
- Database schema: `apps/web/prisma/schema.prisma`
- Types/interfaces: `apps/web/types/exam.ts` and `apps/web/types/capacity.ts`

### Technical Constraints
- **TypeScript 5.0+:** Full type safety across stack [Source: architecture/section-3-tech-stack.md]
- **Prisma ORM:** Database operations with type safety [Source: architecture/section-3-tech-stack.md]
- **tRPC:** End-to-end type safety for API routes [Source: architecture/section-3-tech-stack.md]
- **Vercel Edge Config:** Session capacity caching [Source: architecture/section-2-high-level-architecture.md]

## Testing

### Testing Standards
**Expected Testing Approach** based on tech stack [Source: architecture/section-3-tech-stack.md]:
- **Jest 29+:** Unit and integration testing for business logic
- **Playwright:** E2E testing for exam workflow validation
- **Test Focus:** Capacity management algorithm validation, exam code generation, UI behavior

**Test File Locations:**
- Unit tests: `apps/web/__tests__/capacity-management.test.ts`
- Integration tests: `apps/web/__tests__/api/exam-registration.test.ts`
- E2E tests: `apps/web/e2e/registration-flow.spec.ts`

### Testing Requirements
- Unit tests for capacity calculation logic (300/150 algorithm)
- Integration tests for API endpoint capacity validation
- E2E tests for complete registration flow
- Performance tests for concurrent capacity checking
- Code generation uniqueness and format validation tests

## Change Log

| Date       | Version | Description                                                                         | Author |
| ---------- | ------- | ----------------------------------------------------------------------------------- | ------ |
| 2025-09-13 | 1.0     | Story 3.1 created for system architecture alignment replacing original UI/UX mockup story | SM Bob |
| 2025-09-13 | 1.1     | Story approved after validation fixes and PO review                                | SM Bob |

## Dev Agent Record

### Agent Model Used
*To be populated by the development agent during implementation*

### Debug Log References
*To be populated by the development agent during implementation*

### Completion Notes List
*To be populated by the development agent during implementation*

### File List
*To be populated by the development agent during implementation*

## QA Results
*To be populated by QA Agent after completion of development*