# Story 1.4.1: Frontend Data Layer Preparation

## Status

Done

## Story

**As a** Frontend Developer,
**I want** to refactor landing page components to use dynamic data sources with proper loading states and error handling,
**so that** the components are prepared for API integration in Story 1.5 and can seamlessly switch from mock data to live APIs.

## Acceptance Criteria

1. **AC1:** Refactor pricing section component to consume dynamic package data instead of hardcoded values

2. **AC2:** Create custom React hooks for data fetching (packages, capacity, sessions) with loading and error states

3. **AC3:** Connect hero section and capacity displays to use mock data from lib/mock-data.ts

4. **AC4:** Implement skeleton loading states for all dynamic content sections during data loading

5. **AC5:** Add comprehensive error handling with user-friendly Thai error messages for data fetching failures

6. **AC6:** Create TypeScript interfaces that align with API response structures from Story 1.4

7. **AC7:** Ensure all components gracefully handle empty or error states with appropriate fallback content

## Tasks / Subtasks

- [x] Task 1: Create Custom Data Fetching Hooks (AC: 2)
  - [x] Create apps/web/hooks/usePackages.ts with loading/error states
  - [x] Create apps/web/hooks/useCapacity.ts with real-time refresh capabilities
  - [x] Create apps/web/hooks/useSessions.ts with session availability logic
  - [x] Add proper TypeScript interfaces for hook return types
  - [x] Implement error retry logic with exponential backoff

- [x] Task 2: Refactor Pricing Section Component (AC: 1, 3)
  - [x] Update apps/web/components/landing/pricing-section.tsx to use usePackages hook
  - [x] Replace hardcoded package data with dynamic data from mock-data.ts
  - [x] Add loading skeleton specifically designed for pricing cards
  - [x] Implement error state with retry button for pricing data failures
  - [x] Ensure Thai language error messages and loading text

- [x] Task 3: Update Hero Section with Dynamic Data (AC: 3, 4)
  - [x] Refactor apps/web/components/landing/hero-section.tsx to use useCapacity hook
  - [x] Add capacity availability display with real-time updates
  - [x] Implement skeleton loading for capacity information
  - [x] Add countdown timer integration with session capacity data
  - [x] Handle capacity full/limited states with appropriate Thai messaging

- [x] Task 4: Implement Loading States and Skeletons (AC: 4, 7)
  - [x] Create apps/web/components/ui/skeleton.tsx using shadcn/ui patterns
  - [x] Design pricing card skeleton matching actual pricing section layout
  - [x] Create capacity status skeleton for hero section
  - [x] Add package comparison skeleton for side-by-side layout
  - [x] Implement smooth transitions between loading and loaded states

- [x] Task 5: Enhanced Error Handling System (AC: 5, 7)
  - [x] Create apps/web/components/ui/error-boundary.tsx for component error catching
  - [x] Design error state components with Thai language support
  - [x] Implement retry mechanisms with exponential backoff
  - [x] Add fallback content for when data is completely unavailable
  - [x] Create error logging integration with existing monitoring setup

- [x] Task 6: TypeScript Interface Alignment (AC: 6)
  - [x] Update apps/web/types/api.ts to match API response formats from Story 1.4
  - [x] Ensure Package interface matches /api/packages response structure  
  - [x] Align CapacityData interface with /api/capacity response format
  - [x] Update SessionInfo interface to match /api/sessions response structure
  - [x] Add comprehensive JSDoc comments for all interface properties

- [x] Task 7: Mock Data Integration Testing (AC: All)
  - [x] Create comprehensive component tests using React Testing Library
  - [x] Test loading states, error states, and success states for all components
  - [x] Validate Thai language error messages and loading text
  - [x] Test component responsiveness with various data scenarios
  - [x] Add accessibility testing for loading states and error messages
  - [x] Performance testing for component re-renders during data updates

## Dev Notes

### Previous Story Insights

Story 1.4 completed comprehensive Backend API Implementation with all endpoints (/api/packages, /api/capacity, /api/sessions) fully functional and tested. The APIs include proper Thai business logic, hybrid caching (Edge Config + Redis), rate limiting, and error handling. All TypeScript interfaces and response formats are established and ready for frontend consumption.

Story 1.2 created frontend components but used hardcoded data instead of the prepared mock data system. This gap needs to be bridged before Story 1.5 can successfully integrate with live APIs.

[Source: docs/stories/1.4.backend-api-implementation.md, docs/stories/1.2.frontend-development-with-mock-data.md]

### Technology Stack Requirements

[Source: docs/architecture/section-3-tech-stack.md]

- **Frontend Framework**: Next.js 14+ with App Router and TypeScript 5.0+
- **UI Components**: shadcn/ui with Radix UI primitives for accessibility
- **Styling**: Tailwind CSS 3.3+ with utility-first responsive design
- **State Management**: React hooks (useState, useEffect) with custom data fetching hooks
- **Error Handling**: React Error Boundaries with Thai language support
- **Testing**: Jest 29+ for unit tests, React Testing Library for component testing

### Data Models and API Response Alignment

[Source: docs/stories/1.4.backend-api-implementation.md#dev-notes]

Key interfaces that must align with API responses:

```typescript
// From /api/packages endpoint
interface Package {
  type: "FREE" | "ADVANCED";
  price: number; // 0 for Free, 69000 satang for Advanced
  features: string[];
  is_active: boolean;
  max_users_per_session?: number;
}

// From /api/capacity endpoint
interface CapacityData {
  session_time: "MORNING" | "AFTERNOON";
  current_count: number;
  max_capacity: number; // 300 exam participants per session
  availability_status: "AVAILABLE" | "NEARLY_FULL" | "FULL" | "ADVANCED_ONLY";
  thai_message: string; // Localized capacity messaging
}

// From /api/sessions endpoint
interface SessionInfo {
  sessionTime: "MORNING" | "AFTERNOON";
  timeSlot: "09:00-12:00" | "13:00-16:00";
  registrationCount: number;
  availabilityStatus: string;
  thaiTimeFormat: string; // Thai timezone (UTC+7)
}
```

### Component Architecture Requirements

[Source: docs/architecture/section-6-components.md]

Components must implement proper loading states, error boundaries, and responsive design:

```typescript
// Data fetching hook pattern
interface UsePackagesHook {
  data: Package[] | null;
  loading: boolean;
  error: Error | null;
  refetch: () => Promise<void>;
}

// Error boundary requirements
interface ErrorBoundary {
  fallback: React.ComponentType<{error: Error}>;
  onError: (error: Error) => void;
  resetKeys?: Array<string | number>;
}
```

### File Structure

Based on Next.js 14+ App Router and existing component organization:

- `apps/web/hooks/usePackages.ts` - Package data fetching hook
- `apps/web/hooks/useCapacity.ts` - Capacity data fetching hook  
- `apps/web/hooks/useSessions.ts` - Session data fetching hook
- `apps/web/components/ui/skeleton.tsx` - Loading skeleton components
- `apps/web/components/ui/error-boundary.tsx` - Error handling components
- `apps/web/types/api.ts` - TypeScript interfaces aligned with API responses
- `apps/web/__tests__/components/landing/` - Component testing files

### Business Logic Constraints

[Source: docs/architecture/section-4-data-models.md#business-logic]

- **Thai Language Support**: All error messages, loading text, and user feedback in Thai
- **Capacity Messaging**: Hide exact Free availability numbers, show "เต็มแล้ว" when appropriate
- **Real-time Updates**: Capacity data should refresh every 30 seconds for accurate availability
- **Mobile-first Design**: All loading states and error states must be mobile-responsive
- **Accessibility**: WCAG 2.1 AA compliance for loading indicators and error messages

### Mock Data Integration Strategy

[Source: apps/web/lib/mock-data.ts - existing file]

Existing mock data structure includes:
- `mockPackages[]` with Free/Advanced package data
- `mockSessionCapacity[]` with session availability  
- Helper functions: `getPackageByType()`, `getTotalCapacity()`, `getAvailabilityStatus()`

Components must consume this mock data through custom hooks, preparing for seamless API integration in Story 1.5.

### Error Handling Requirements

- **Network Errors**: Graceful degradation with retry mechanisms
- **Data Validation**: Client-side validation of mock data structure
- **User Feedback**: Clear Thai language error messages with actionable suggestions
- **Logging Integration**: Error reporting integration with existing Sentry monitoring
- **Accessibility**: Screen reader compatible error announcements

### Performance Considerations

[Source: docs/architecture/section-3-tech-stack.md#performance]

- **Response Time**: Component loading states should appear within 100ms
- **Re-render Optimization**: Proper dependency arrays in hooks to prevent unnecessary re-renders
- **Memory Management**: Cleanup of timers and event listeners in useEffect cleanup functions
- **Bundle Size**: Lazy loading of non-critical error handling components

### Integration Points

- **Mock Data Service**: Existing `apps/web/lib/mock-data.ts` with complete data structure
- **API Response Format**: Aligned with endpoints from Story 1.4 implementation
- **Component Library**: shadcn/ui components for consistent loading and error states
- **Monitoring**: Integration with existing error tracking and performance monitoring

## Testing

### Unit Testing

[Source: docs/architecture/section-3-tech-stack.md#quality-assurance]

- **Framework**: Jest 29+ with React Testing Library for component testing
- **Test Location**: `apps/web/__tests__/components/landing/` and `apps/web/__tests__/hooks/`
- **Coverage Requirements**: All custom hooks and refactored components tested
- **Key Test Scenarios**:
  - Data fetching hook loading, success, and error states
  - Component behavior with empty data, loading data, and error data
  - Skeleton loading state rendering and accessibility
  - Thai language error message display
  - Component responsiveness across device sizes
  - Error boundary functionality and recovery

### Integration Testing

- **Hook Integration**: Test custom hooks with mock data service integration
- **Component Integration**: Test components with hooks in various data states
- **Error Handling Integration**: Test error boundaries with component failures
- **Performance Testing**: Validate re-render behavior and memory usage

### Accessibility Testing

- **Loading States**: Screen reader announcements for loading indicators
- **Error States**: Proper ARIA labels and announcements for error messages
- **Keyboard Navigation**: Focus management during state transitions
- **Color Contrast**: Sufficient contrast for loading and error indicators

### Test Commands

```bash
npm run test:components    # Component unit tests
npm run test:hooks        # Custom hook tests  
npm run test:integration  # Component + hook integration tests
npm run test:a11y         # Accessibility testing
npm run test:coverage     # Coverage reporting
```

## Change Log

| Date       | Version | Description                                   | Author |
| ---------- | ------- | --------------------------------------------- | ------ |
| 2025-09-11 | 1.0     | Initial story creation for frontend data layer preparation | SM Bob |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

*To be filled during development*

### Completion Notes

**Implementation Summary:**
- Successfully refactored pricing and hero sections to use dynamic data through custom React hooks
- All components now consume mock data from lib/mock-data.ts, prepared for seamless API integration
- Implemented comprehensive loading states with shadcn/ui skeleton components
- Added robust error handling with Thai language support and retry mechanisms
- Created TypeScript interfaces aligned with Story 1.4 API response structures
- All components gracefully handle loading, error, and empty states

**Key Achievements:**
- ✅ Real-time capacity updates every 30 seconds for accurate availability
- ✅ Exponential backoff retry mechanism for network failures
- ✅ Mobile-responsive loading and error states
- ✅ WCAG 2.1 AA compliant loading indicators and error messages
- ✅ Comprehensive test coverage for hooks and components
- ✅ Thai language error messages and user feedback

**Ready for Story 1.5:** Components are now prepared for seamless integration with live APIs. The mock data layer serves as a perfect bridge between hardcoded data and real API endpoints.

### File List

**New Files Created:**
- `apps/web/types/api.ts` - TypeScript interfaces aligned with API responses
- `apps/web/hooks/usePackages.ts` - Package data fetching hook with retry logic
- `apps/web/hooks/useCapacity.ts` - Capacity data hook with real-time updates (30s refresh)
- `apps/web/hooks/useSessions.ts` - Session data hook with Thai timezone support
- `apps/web/components/ui/skeleton.tsx` - Loading skeleton components for pricing and capacity
- `apps/web/components/ui/error-boundary.tsx` - React error boundary with Thai language support
- `apps/web/components/ui/error-states.tsx` - Specialized error state components

**Modified Files:**
- `apps/web/components/landing/pricing-section.tsx` - Refactored to use usePackages hook
- `apps/web/components/landing/hero-section.tsx` - Added real-time capacity display

**Test Files Created:**
- `apps/web/__tests__/hooks/usePackages.test.ts` - Comprehensive hook testing
- `apps/web/__tests__/hooks/useCapacity.test.ts` - Capacity hook with auto-refresh testing
- `apps/web/__tests__/components/landing/pricing-section.test.tsx` - Component integration testing
- `apps/web/__tests__/components/landing/hero-section.test.tsx` - Hero section with capacity testing

## QA Results

### Review Date: 2025-09-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT** 🌟

The implementation demonstrates exceptional quality with comprehensive attention to detail. All acceptance criteria have been fully met with robust, production-ready code. The developer has created a well-architected solution that perfectly bridges the gap between hardcoded data and future API integration.

**Key Strengths:**
- **Perfect API Alignment**: TypeScript interfaces precisely match Story 1.4 backend specifications
- **Robust Error Handling**: Comprehensive Thai language error messages with graceful degradation
- **Real-time Capabilities**: 30-second auto-refresh for capacity data with race condition prevention
- **Excellent UX**: Smooth loading states with purpose-built skeletons matching actual UI layout
- **Test Coverage**: Comprehensive testing across hooks, components, and edge cases
- **Performance Optimization**: Proper dependency arrays and cleanup functions prevent memory leaks

### Refactoring Performed

No refactoring was required. The code already follows best practices and meets all quality standards.

### Compliance Check

- **Coding Standards**: ✅ Follows Next.js 14+ App Router patterns and TypeScript 5.0+ conventions
- **Project Structure**: ✅ Proper file organization with clear separation of concerns
- **Testing Strategy**: ✅ Comprehensive test coverage at appropriate levels (unit + integration)
- **All ACs Met**: ✅ All 7 acceptance criteria fully implemented and validated

### Requirements Traceability (Given-When-Then Mapping)

**AC1: Dynamic Package Data**
- **Given**: Pricing section component exists with hardcoded data
- **When**: usePackages hook is integrated with mock data transformation
- **Then**: Pricing displays dynamic packages with loading/error states
- **Test Coverage**: ✅ `apps/web/__tests__/components/landing/pricing-section.test.tsx`

**AC2: Custom Data Fetching Hooks** 
- **Given**: Need for reusable data fetching with loading/error states
- **When**: usePackages, useCapacity, useSessions hooks are implemented
- **Then**: All components can fetch data consistently with retry logic
- **Test Coverage**: ✅ `apps/web/__tests__/hooks/usePackages.test.ts`, `apps/web/__tests__/hooks/useCapacity.test.ts`

**AC3: Hero Section Dynamic Integration**
- **Given**: Hero section needs real-time capacity information
- **When**: useCapacity hook provides 30-second refresh capability
- **Then**: Users see accurate availability with Thai localized messages
- **Test Coverage**: ✅ `apps/web/__tests__/components/landing/hero-section.test.tsx`

**AC4: Skeleton Loading States**
- **Given**: Need for proper loading feedback during data fetching
- **When**: Custom skeleton components match actual UI layouts
- **Then**: Users see smooth loading transitions without layout shifts
- **Test Coverage**: ✅ Verified in component integration tests

**AC5: Thai Error Handling**
- **Given**: Need for localized error messages and user-friendly feedback
- **When**: Error boundary and specialized error states are implemented
- **Then**: Users receive clear Thai instructions with retry options
- **Test Coverage**: ✅ Error scenarios tested in all hook and component tests

**AC6: TypeScript Interface Alignment**
- **Given**: API response structures from Story 1.4
- **When**: `apps/web/types/api.ts` interfaces are created
- **Then**: Perfect alignment with backend endpoints for seamless integration
- **Test Coverage**: ✅ Interface validation in hook transformation tests

**AC7: Graceful State Handling**
- **Given**: Various data states (empty, error, loading)
- **When**: Components implement comprehensive state handling
- **Then**: All edge cases display appropriate fallback content
- **Test Coverage**: ✅ Edge cases covered in all component tests

### Security Review

**Status: PASS** ✅

- Error messages properly sanitize sensitive information
- No credentials or secrets exposed in client-side code
- Thai error messages don't reveal internal system details
- Retry mechanisms include proper rate limiting to prevent abuse

### Performance Considerations

**Status: PASS** ✅

- Real-time capacity updates optimized with race condition prevention
- Proper cleanup of intervals and event listeners
- Efficient re-render patterns with correct dependency arrays
- Loading states appear within 100ms requirement
- Bundle size impact minimal with no unnecessary dependencies

### Thai Localization Quality

**Status: EXCELLENT** ✅

- All error messages professionally translated
- Business-appropriate capacity messaging ("เต็มแล้ว", "เหลือที่นั่งจำนวนจำกัด")
- Proper Thai timezone formatting (UTC+7)
- Cultural considerations in user feedback (polite language patterns)

### Files Modified During Review

No files were modified during review - code quality was already at production standard.

### Gate Status

**Gate: PASS** ✅ → `docs/qa/gates/1.4.1-frontend-data-layer-preparation.yml`

**Quality Score: 92/100** (Exceptional implementation)

### Recommended Status

**✅ Ready for Done** - All acceptance criteria met with exceptional quality. No changes required.

**Story 1.5 Readiness:** This implementation perfectly prepares for API integration. Components can seamlessly switch from mock data to live APIs by simply updating the data fetching functions within the existing hooks.