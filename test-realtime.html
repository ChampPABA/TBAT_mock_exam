<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBAT Real-time Capacity Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .available { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .limited { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .full { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .logs { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .info { color: #17a2b8; }
        .timestamp { color: #6c757d; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ TBAT Real-time Capacity Testing</h1>
        <p>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ö‡∏ö real-time ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á TBAT</p>
        
        <div class="stats">
            <div class="stat-card">
                <h3>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h3>
                <div>‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <span id="successCount">0</span></div>
                <div>‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: <span id="errorCount">0</span></div>
                <div>üîÑ ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalCalls">0</span></div>
            </div>
            <div class="stat-card">
                <h3>‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á</h3>
                <div>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: <span id="avgResponseTime">0</span> ms</div>
                <div>‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastResponseTime">0</span> ms</div>
                <div>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastUpdate">‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢</span></div>
            </div>
        </div>

        <div class="status" id="capacityStatus">
            üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
        </div>

        <div>
            <button onclick="startPolling()" id="startBtn">üü¢ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Real-time</button>
            <button onclick="stopPolling()" id="stopBtn" disabled>üî¥ ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
            <button onclick="testOnce()" id="testBtn">‚ö° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</button>
            <button onclick="clearLogs()" id="clearBtn">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á Logs</button>
        </div>

        <h3>üìù Activity Logs</h3>
        <div class="logs" id="logs">
            <div class="timestamp">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô test page - ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö...</div>
        </div>
    </div>

    <script>
        let pollingInterval = null;
        let stats = {
            success: 0,
            error: 0,
            total: 0,
            responseTimes: []
        };

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString('th-TH');
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        function updateStats() {
            document.getElementById('successCount').textContent = stats.success;
            document.getElementById('errorCount').textContent = stats.error;
            document.getElementById('totalCalls').textContent = stats.total;
            
            if (stats.responseTimes.length > 0) {
                const avg = stats.responseTimes.reduce((a, b) => a + b, 0) / stats.responseTimes.length;
                document.getElementById('avgResponseTime').textContent = Math.round(avg);
                document.getElementById('lastResponseTime').textContent = stats.responseTimes[stats.responseTimes.length - 1];
            }
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('th-TH');
        }

        async function fetchCapacity() {
            const startTime = Date.now();
            stats.total++;
            
            try {
                log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API /api/capacity...', 'info');
                
                const response = await fetch('http://localhost:3001/api/capacity');
                const responseTime = Date.now() - startTime;
                stats.responseTimes.push(responseTime);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                stats.success++;
                
                log(`‚úÖ API ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡πÄ‡∏ß‡∏•‡∏≤ ${responseTime}ms`, 'success');
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• capacity
                const morningSession = data.data.sessions.morning;
                const afternoonSession = data.data.sessions.afternoon;
                
                const statusElement = document.getElementById('capacityStatus');
                let statusClass = 'available';
                let statusText = '';
                
                if (data.data.overall.overallStatus === 'AVAILABLE') {
                    statusClass = 'available';
                    statusText = `üü¢ ${morningSession.message} - ‡πÄ‡∏ä‡πâ‡∏≤: ${morningSession.totalCount}/${morningSession.maxCapacity} | ‡∏ö‡πà‡∏≤‡∏¢: ${afternoonSession.totalCount}/${afternoonSession.maxCapacity}`;
                } else if (data.data.overall.overallStatus === 'NEARLY_FULL') {
                    statusClass = 'limited';  
                    statusText = `üü° ${morningSession.message} - ‡πÄ‡∏ä‡πâ‡∏≤: ${morningSession.totalCount}/${morningSession.maxCapacity} | ‡∏ö‡πà‡∏≤‡∏¢: ${afternoonSession.totalCount}/${afternoonSession.maxCapacity}`;
                } else {
                    statusClass = 'full';
                    statusText = `üî¥ ${morningSession.message} - ‡πÄ‡∏ä‡πâ‡∏≤: ${morningSession.totalCount}/${morningSession.maxCapacity} | ‡∏ö‡πà‡∏≤‡∏¢: ${afternoonSession.totalCount}/${afternoonSession.maxCapacity}`;
                }
                
                statusElement.className = `status ${statusClass}`;
                statusElement.textContent = statusText;
                
                log(`üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${statusText}`, 'info');
                
            } catch (error) {
                stats.error++;
                const responseTime = Date.now() - startTime;
                stats.responseTimes.push(responseTime);
                
                log(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message} (${responseTime}ms)`, 'error');
                
                const statusElement = document.getElementById('capacityStatus');
                statusElement.className = 'status full';
                statusElement.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á';
            }
            
            updateStats();
        }

        function startPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            log('üü¢ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Real-time ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ', 'success');
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            fetchCapacity();
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ interval 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            pollingInterval = setInterval(fetchCapacity, 30000);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            
            log('üî¥ ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Real-time ‡πÅ‡∏•‡πâ‡∏ß', 'error');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function testOnce() {
            log('‚ö° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', 'info');
            fetchCapacity();
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div class="timestamp">‡∏•‡πâ‡∏≤‡∏á logs ‡πÅ‡∏•‡πâ‡∏ß...</div>';
            stats = { success: 0, error: 0, total: 0, responseTimes: [] };
            updateStats();
        }

        // Auto-start ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.addEventListener('load', () => {
            log('üöÄ ‡∏´‡∏ô‡πâ‡∏≤ test ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Real-time" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'success');
        });
    </script>
</body>
</html>